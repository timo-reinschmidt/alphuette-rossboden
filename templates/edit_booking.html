{% extends "base.html" %}
{% block title %}Reservation bearbeiten{% endblock %}

{% block content %}
    <h2>Reservation bearbeiten</h2>

    <form method="POST" class="w3-container w3-card-4 w3-light-grey w3-padding">

        <!-- Formular im Flexbox-Layout mit Abstand zwischen den Spalten -->
        <div class="w3-row">
            <!-- Linke Spalte -->
            <div class="w3-half w3-padding-right">
                <label>Name</label>
                <input class="w3-input w3-margin-bottom" type="text" name="name" value="{{ booking.name }}" required>

                <label>Geburtsdatum</label>
                <input class="w3-input w3-margin-bottom" type="date" name="birthdate" value="{{ booking.birthdate }}"
                       required>

                <label>E-Mail</label>
                <input class="w3-input w3-margin-bottom" type="email" name="email" value="{{ booking.email }}">

                <label>Telefon</label>
                <input class="w3-input w3-margin-bottom" type="text" name="phone" value="{{ booking.phone }}">

                <!-- Adressfelder -->
                <label>Adresse</label>
                <input class="w3-input w3-margin-bottom" type="text" name="address" value="{{ booking.address }}"
                       required>

                <label>PLZ</label>
                <input class="w3-input w3-margin-bottom" type="text" name="postal_code"
                       value="{{ booking.postal_code }}" required>

                <label>Stadt</label>
                <input class="w3-input w3-margin-bottom" type="text" name="city" value="{{ booking.city }}" required>

                <label>Land</label>
                <input class="w3-input w3-margin-bottom" type="text" name="country" value="{{ booking.country }}"
                       required>

                <label>Anreise</label>
                <input class="w3-input w3-margin-bottom" type="date" name="arrival" value="{{ booking.arrival }}"
                       required>

                <label>Abreise</label>
                <input class="w3-input w3-margin-bottom" type="date" name="departure" value="{{ booking.departure }}"
                       required>
            </div>

            <!-- Rechte Spalte -->
            <div class="w3-half w3-padding-left w3-margin-left">


                <label>Zimmer</label>
                <select class="w3-select w3-margin-bottom" name="room" required>
                    {% for room in rooms %}
                        <option value="{{ room }}" {% if room == booking.room %}selected{% endif %}>{{ room }}</option>
                    {% endfor %}
                </select>

                <br>
                <label>Anzahl Gäste</label>
                <input class="w3-input w3-margin-bottom" type="number" name="guests" id="guests"
                       value="{{ booking.guests }}" min="1" required>

                <br>
                <!-- Dynamische Felder für Mitreisende -->
                <div id="guest-details">
                    {% for guest in guests %}
                        <label>Name Mitreisender {{ loop.index }}</label>
                        <input class="w3-input w3-margin-bottom" name="guest_name_{{ loop.index }}"
                               value="{{ guest.name }}">

                        <label>Geburtsdatum Mitreisender {{ loop.index }}</label>
                        <input class="w3-input w3-margin-bottom" name="guest_birth_{{ loop.index }}" type="date"
                               value="{{ guest.birthdate }}">

                        <!-- Entfernen-Button -->
                        <button type="button" class="w3-button w3-red w3-margin-top"
                                onclick="removeGuest({{ loop.index }})">Entfernen
                        </button>
                    {% endfor %}
                </div>

                <br>
                <button type="button" id="add-guest" class="w3-button w3-blue w3-margin-top">+ Mitreisenden hinzufügen
                </button>

                <br><br>
                <!-- HP und Essensoptionen -->
                <label>HP (Halbpension)</label>
                <input class="w3-check" type="checkbox" name="hp" {% if booking.hp == 'Ja' %}checked{% endif %}>

                <label>Fleischanteil</label>
                <input class="w3-input w3-margin-bottom" type="number" name="hp_fleisch"
                       value="{{ booking.hp_fleisch or '' }}" min="0" {% if booking.hp != 'Ja' %}disabled{% endif %}>

                <label>Vegi-Anteil</label>
                <input class="w3-input w3-margin-bottom" type="number" name="hp_vegi"
                       value="{{ booking.hp_vegi or '' }}" min="0" {% if booking.hp != 'Ja' %}disabled{% endif %}>

                <label>Status</label>
                <select class="w3-select w3-margin-bottom" name="status">
                    {% for s in ['Option', 'Bestätigt', 'Checked In', 'Storniert'] %}
                        <option value="{{ s }}" {% if booking.status == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>

                <br>
                <label>Notiz</label>
                <textarea class="w3-input w3-margin-bottom" name="note">{{ booking.notes }}</textarea>

                <div class="w3-text-red w3-margin-top">
                    <strong>Preisvorschau: CHF <span id="price-preview">0.00</span></strong>
                </div>

                <button class="w3-button w3-blue w3-margin-top" type="submit">Speichern</button>
            </div>
        </div>
    </form>

    <form method="post" action="/cancel_booking/{{ booking.id }}"
          onsubmit="return confirm('Buchung wirklich stornieren?');">
        <button class="w3-button w3-red w3-margin-top">Buchung stornieren</button>
    </form>

    <form method="post" action="/delete_booking/{{ booking.id }}"
          onsubmit="return confirm('Buchung wirklich löschen?');">
        <button class="w3-button w3-red w3-margin-top">Buchung löschen</button>
    </form>

    <h3>Status-Änderungen</h3>
    <table class="w3-table w3-striped">
        <thead>
        <tr>
            <th>Datum</th>
            <th>Alter Status</th>
            <th>Geändert von</th>
        </tr>
        </thead>
        <tbody>
        {% for entry in history %}
            <tr>
                <td>{{ entry.changed_at }}</td>
                <td>{{ entry.status }}</td>
                <td>{{ entry.changed_by }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <script src="/static/main.js"></script>
    <script src="/static/dinnerOptions.js" defer></script>

{% endblock %}